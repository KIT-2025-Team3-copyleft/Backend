name: Deploy to Mini PC (Direct Build)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-direct:
    runs-on: self-hosted

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ì†ŒìŠ¤ì½”ë“œ ë™ê¸°í™”
        run: |
          # --exclude: ì´ í´ë”/íŒŒì¼ì€ ì§€ìš°ì§€ë„ ë§ê³  ë®ì–´ì“°ì§€ë„ ë§ˆë¼
          rsync -av --delete \
            --exclude='.git' \
            --exclude='frontend' \
            --exclude='uploads' \
            --exclude='.env' \
            ./ /home/woni/server/OSP_GodsChoice/

      - name: ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì¬ì‹¤í–‰
        run: |
          cd ~/server/OSP_GodsChoice
          
          echo "ğŸ—ï¸ ë¡œì»¬ ë¹Œë“œ ì‹œì‘..."
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test
          
          # prod íŒŒì¼ì´ ì•„ë‹ˆë¼ ê¸°ë³¸ íŒŒì¼ ì‚¬ìš©
          docker compose up -d --build
          
          docker image prune -f
          echo "âœ… ë°°í¬ ì™„ë£Œ!"